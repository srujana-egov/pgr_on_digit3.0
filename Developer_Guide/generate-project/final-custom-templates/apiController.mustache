package {{package}};

{{#imports}}
import {{import}};
{{/imports}}

import {{servicePackage}}.{{classname}}ApiDelegate;

import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.multipart.MultipartFile;

import jakarta.validation.Valid;
import jakarta.validation.constraints.*;

import java.net.URI;
import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.annotation.Generated;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Generated(
        value = "org.openapitools.codegen.languages.SpringCodegen",
        date = "{{generatedDate}}",
        comments = "Generator version: {{generatorVersion}}"
)
@RestController
@RequestMapping   // No base path â†’ paths come from OpenAPI spec
@RequiredArgsConstructor
@Slf4j
public class {{classname}}{{#delegatePattern}}Controller{{/delegatePattern}}{{^delegatePattern}}{{/delegatePattern}} {

    private final {{classname}}ApiDelegate service;

    private static final Pattern REALM_PATTERN = Pattern.compile(".*/realms/([^/]+)/*$");

    private List<String> getRealmRoles(Jwt jwt) {
        if (jwt == null) return List.of();
        Map<String, Object> realmAccess = jwt.getClaim("realm_access");
        if (realmAccess == null) return List.of();
        @SuppressWarnings("unchecked")
        List<String> roles = (List<String>) realmAccess.getOrDefault("roles", List.of());
        return roles;
    }

    private static String getTenantIdFromIssuer(Jwt jwt) {
        if (jwt == null || jwt.getIssuer() == null) return null;
        String iss = jwt.getIssuer().toString();
        Matcher m = REALM_PATTERN.matcher(iss);
        if (m.matches()) return m.group(1);

        try {
            String path = URI.create(iss).getPath();
            Matcher m2 = REALM_PATTERN.matcher(path);
            if (m2.matches()) return m2.group(1);
        } catch (Exception ignored) {}
        return null;
    }

{{#operations}}
{{#operation}}

    {{#isDeprecated}}
    @Deprecated
    {{/isDeprecated}}
    @RequestMapping(
            value = "{{{path}}}",
            method = RequestMethod.{{httpMethod}}{{#hasConsumes}},
            consumes = { {{#consumes}}"{{{mediaType}}}"{{^-last}}, {{/-last}}{{/consumes}} }{{/hasConsumes}}{{#hasProduces}},
            produces = { {{#produces}}"{{{mediaType}}}"{{^-last}}, {{/-last}}{{/produces}} }{{/hasProduces}}
    )
    public ResponseEntity<{{#returnType}}{{{returnType}}}{{/returnType}}{{^returnType}}Void{{/returnType}}> {{#lambda.camelcase}}{{classVarName}}{{/lambda.camelcase}}{{#lambda.titlecase}}{{operationId}}{{/lambda.titlecase}}(
            {{#allParams}}
            {{#isBodyParam}}@RequestBody {{#required}}@Valid {{/required}}{{dataType}} {{paramName}}{{/isBodyParam}}
            {{#isQueryParam}}@RequestParam(value = "{{baseName}}", required = {{#required}}true{{/required}}{{^required}}false{{/required}}) {{dataType}} {{paramName}}{{/isQueryParam}}
            {{#isPathParam}}@PathVariable("{{baseName}}") {{#required}}@NotNull {{/required}}{{dataType}} {{paramName}}{{/isPathParam}}
            {{#isHeaderParam}}@RequestHeader(value = "{{baseName}}", required = {{#required}}true{{/required}}{{^required}}false{{/required}}) {{dataType}} {{paramName}}{{/isHeaderParam}}{{^-last}}, {{/-last}}
            {{/allParams}}{{#allParams}}, {{/allParams}}@AuthenticationPrincipal Jwt jwt
    ) {

        {{!-- required param validation --}}
        {{#allParams}}
        {{#required}}
        if ({{paramName}} == null) {
            log.warn("{{operationId}}: missing required parameter '{{paramName}}'");
            return ResponseEntity.badRequest().build();
        }
        {{/required}}
        {{/allParams}}

        List<String> roles = getRealmRoles(jwt);
        String tenantId = getTenantIdFromIssuer(jwt);
        log.debug("{{operationId}}: roles={}, tenant={}", roles, tenantId);

        {{#returnType}}
        {{{returnType}}} result = service.{{#lambda.camelcase}}{{classVarName}}{{/lambda.camelcase}}{{#lambda.titlecase}}{{operationId}}{{/lambda.titlecase}}(
                {{#allParams}}{{paramName}}{{^-last}}, {{/-last}}{{/allParams}}{{#vendorExtensions.x-pass-roles}}, roles{{/vendorExtensions.x-pass-roles}}{{#vendorExtensions.x-pass-tenant}}, tenantId{{/vendorExtensions.x-pass-tenant}}
        );
        return ResponseEntity.ok(result);
        {{/returnType}}
        {{^returnType}}
        service.{{#lambda.camelcase}}{{classVarName}}{{/lambda.camelcase}}{{#lambda.titlecase}}{{operationId}}{{/lambda.titlecase}}(
                {{#allParams}}{{paramName}}{{^-last}}, {{/-last}}{{/allParams}}{{#vendorExtensions.x-pass-roles}}, roles{{/vendorExtensions.x-pass-roles}}{{#vendorExtensions.x-pass-tenant}}, tenantId{{/vendorExtensions.x-pass-tenant}}
        );
        return ResponseEntity.ok().build();
        {{/returnType}}
    }

{{/operation}}
{{/operations}}
}
